<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>OCR Ultra Final (Client-Side)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Tailwind CSS (CDN) pour un design moderne et épuré -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  
  <!-- OpenCV.js pour prétraiter l'image -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  
  <!-- JsBarcode pour les codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    /* ----- HEADER FLAT DESIGN ----- */
    header {
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem;
      text-align: center;
    }
    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #1f2937;
      margin: 0;
    }

    /* ----- CONTAINER ----- */
    .container {
      max-width: 900px;
      margin: 1rem auto 3rem;
      padding: 0 1rem;
    }

    /* ----- CARD ----- */
    .card {
      @apply bg-white shadow-md rounded-lg p-4 mb-6;
    }

    /* ----- BUTTONS ----- */
    .btn-primary {
      @apply bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-semibold;
    }
    .btn-secondary {
      @apply bg-gray-200 text-gray-700 py-2 px-4 rounded hover:bg-gray-300 font-semibold;
    }

    /* ----- SPINNER ----- */
    .spinner {
      @apply animate-spin h-12 w-12 text-blue-600;
    }

    /* ----- FEEDBACK ----- */
    .feedback-btn {
      min-width: 80px;
    }

    /* ----- BARCODE CARD ----- */
    .barcode-card {
      @apply bg-white shadow-md rounded p-4 flex flex-col items-center mb-4;
    }
    .barcode-title {
      @apply text-sm font-semibold mb-2 text-center;
    }

    /* ----- TEXTAREA ----- */
    textarea {
      @apply w-full p-2 border border-gray-300 rounded mt-2 bg-gray-50;
      resize: vertical;
    }

    /* Fallback si Tailwind @apply non géré */
    [class^="@apply"] {
      /* no-op fallback */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">
  <!-- Header -->
  <header>
    <h1>Extraction Avancée des Serial Numbers</h1>
  </header>

  <!-- Main container -->
  <div class="container">
    <!-- Zone de sélection / prise de photo -->
    <div class="card">
      <label for="imageInput" class="block font-semibold mb-2">
        Sélectionnez ou prenez une photo :
      </label>
      <input
        type="file"
        id="imageInput"
        class="block w-full mb-4"
        accept="image/*;capture=camera"
      />
      
      <div class="flex space-x-2">
        <button id="processBtn" class="btn-primary flex-1 text-center">
          Analyser l'image
        </button>
        <button id="contrastBtn" class="btn-secondary flex-1 text-center">
          Contraste +
        </button>
      </div>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center my-8 hidden">
      <svg
        class="spinner mx-auto"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v8H4z"
        ></path>
      </svg>
      <p class="mt-2 text-blue-600 font-semibold">Analyse en cours...</p>
    </div>

    <!-- Résultats -->
    <div id="results" class="hidden">
      <!-- Texte OCR brut -->
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Texte OCR (ASCII uniquement) :</h2>
        <textarea id="output" rows="8" readonly></textarea>
      </div>

      <!-- Serial numbers détectés -->
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Serial Numbers détectés :</h2>
        <ul id="serialList" class="space-y-2"></ul>
      </div>
    </div>

    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
  </div>

  <footer class="mt-auto bg-gray-100 text-center text-sm text-gray-500 py-4 border-t border-gray-200">
    <p>
      Les numéros validés sont sauvegardés localement et priorisés lors de prochaines analyses.<br/>
      Si un scanner ne lit pas le code-barres, augmentez sa taille (width/height).
    </p>
  </footer>

  <script>
    /************************************************************
     * Pseudo "Machine Learning" local : stockage
     ************************************************************/
    const STORAGE_KEY = "confirmedSerialNumbers";
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      const confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }

    /************************************************************
     * Paramètres de prétraitement
     ************************************************************/
    let extraContrast = false; // si l'utilisateur clique sur "Contraste +"

    /************************************************************
     * Prétraitement d'image (OpenCV.js)
     * - Binarisation adaptative
     * - Option "Contraste +" (plus agressif)
     ************************************************************/
    async function preprocessImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          if (typeof cv === "undefined") {
            return resolve(canvas.toDataURL("image/png"));
          }

          try {
            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // Contraste + (optionnel)
            if (extraContrast) {
              let alpha = 2.0; // plus fort
              let beta = 50.0; // luminosité
              let contrasted = new cv.Mat();
              gray.convertTo(contrasted, -1, alpha, beta);
              gray.delete();
              gray = contrasted;
            }

            // Binarisation adaptative
            let thresh = new cv.Mat();
            cv.adaptiveThreshold(
              gray,
              thresh,
              255,
              cv.ADAPTIVE_THRESH_GAUSSIAN_C,
              cv.THRESH_BINARY,
              15,
              15
            );

            // Flou médian pour réduire le bruit
            cv.medianBlur(thresh, thresh, 3);

            // Rendu final
            cv.imshow(canvas, thresh);

            // Libérer la mémoire
            src.delete();
            gray.delete();
            thresh.delete();

            resolve(canvas.toDataURL("image/png"));
          } catch (err) {
            console.error(err);
            resolve(canvas.toDataURL("image/png"));
          }
        };
        img.onerror = reject;
        const reader = new FileReader();
        reader.onload = (evt) => (img.src = evt.target.result);
        reader.readAsDataURL(file);
      });
    }

    /************************************************************
     * Extraction avancée des Serial Numbers
     *  - Filtrage ASCII
     *  - Mots-clés multiples
     ************************************************************/
    function extractSerialNumbers(rawText) {
      // 1) ASCII only
      let text = rawText
        .replace(/[^\x20-\x7E]/g, "")
        .toUpperCase();

      // 2) Patterns
      const patterns = [
        // Pièces sérialisées, SER, S/N, Part Number...
        /(?:PIECES?\s*SERIALISEES?\s*N[°O]?|SERIAL\s*NUMBERS?|S\/N|SER\s|N°\sDE\sSERIE|NUMERO\sDE\sSERIE|PART\s*NUMBER)\s*[:\-]?\s*([\w\s\-\_]*)/gi,
        // SER CHT 1522 ou SERCHT1522
        /\bSER\s?[A-Z]{0,5}\s?\d+\b/gi,
      ];

      let found = [];
      patterns.forEach((regex) => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          let parts = match[1] ? match[1].split(/[\n,;]+/) : [match[0]];
          parts.forEach((token) => {
            let candidate = token.trim();
            let candidateNoSpace = candidate.replace(/\s+/g, "");
            if (candidateNoSpace.length >= 3 && !found.includes(candidate)) {
              found.push(candidate);
            }
          });
        }
      });

      // 3) Prioriser les numéros validés
      const confirmed = getConfirmedSerialNumbers();
      found.sort((a, b) => confirmed.includes(b) - confirmed.includes(a));

      return { asciiText: text, found };
    }

    /************************************************************
     * Affichage : texte OCR, liste, codes-barres
     ************************************************************/
    function displayResults(asciiText, serialNumbers) {
      // 1) Texte OCR
      const outputEl = document.getElementById("output");
      outputEl.value = asciiText;

      // 2) Liste
      const serialList = document.getElementById("serialList");
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();

      if (serialNumbers.length === 0) {
        const li = document.createElement("li");
        li.className = "bg-gray-100 p-2 rounded";
        li.textContent = "Aucun numéro de série détecté.";
        serialList.appendChild(li);
      } else {
        serialNumbers.forEach((num) => {
          const li = document.createElement("li");
          li.className =
            "bg-gray-50 p-2 rounded flex justify-between items-center";
          const len = num.replace(/\s+/g, "").length;
          li.textContent = `${num} (LEN: ${len})`;

          // Feedback
          const btnGroup = document.createElement("div");
          if (confirmed.includes(num)) {
            // Badge validé
            const badge = document.createElement("span");
            badge.className =
              "bg-green-500 text-white text-xs font-bold px-2 py-1 rounded";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement("button");
            btnValidate.className =
              "feedback-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener("click", () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML =
                '<span class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded">Validé</span>';
            });

            const btnReject = document.createElement("button");
            btnReject.className =
              "feedback-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener("click", () => {
              li.remove();
            });

            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }

      // 3) Codes-barres
      const barcodeArea = document.getElementById("barcodeArea");
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const div = document.createElement("div");
        div.className = "barcode-card";

        const cardTitle = document.createElement("div");
        cardTitle.className = "barcode-title";
        const len = num.replace(/\s+/g, "").length;
        cardTitle.textContent = `${num} (LEN: ${len})`;
        div.appendChild(cardTitle);

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = `barcode-${index}`;
        div.appendChild(svg);

        barcodeArea.appendChild(div);

        // Génération du code-barres
        JsBarcode(svg, num.replace(/\s+/g, ""), {
          format: "CODE128",
          lineColor: "#000",
          width: 4,   // plus large
          height: 100, // plus haut
          displayValue: false,
        });
      });
    }

    /************************************************************
     * Processus global : OCR
     ************************************************************/
    async function runOcr(file) {
      const loadingEl = document.getElementById("loading");
      const resultsEl = document.getElementById("results");
      const barcodeArea = document.getElementById("barcodeArea");
      const serialList = document.getElementById("serialList");
      const outputEl = document.getElementById("output");

      resultsEl.classList.add("hidden");
      barcodeArea.innerHTML = "";
      serialList.innerHTML = "";
      outputEl.value = "";
      loadingEl.classList.remove("hidden");

      try {
        // 1) Prétraiter
        const processedDataUrl = await preprocessImage(file);

        // 2) Tesseract
        const { data } = await Tesseract.recognize(processedDataUrl, "fra+eng", {
          logger: (m) => console.log(m),
        });
        let text = data.text || "";

        // 3) Extraire
        const { asciiText, found } = extractSerialNumbers(text);

        // 4) Afficher
        loadingEl.classList.add("hidden");
        resultsEl.classList.remove("hidden");
        displayResults(asciiText, found);
      } catch (err) {
        console.error(err);
        loadingEl.classList.add("hidden");
        alert("Une erreur est survenue lors de l'analyse.");
      }
    }

    /************************************************************
     * Gestion des boutons
     ************************************************************/
    document.getElementById("processBtn").addEventListener("click", () => {
      const file = document.getElementById("imageInput").files[0];
      if (!file) {
        alert("Veuillez sélectionner ou prendre une photo.");
        return;
      }
      extraContrast = false;
      runOcr(file);
    });

    document.getElementById("contrastBtn").addEventListener("click", () => {
      const file = document.getElementById("imageInput").files[0];
      if (!file) {
        alert("Veuillez sélectionner ou prendre une photo.");
        return;
      }
      extraContrast = true;
      runOcr(file);
    });
  </script>
</body>
</html>