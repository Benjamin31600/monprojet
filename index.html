<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Extraction Avancée des Serial Numbers</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tesseract.js pour l'OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <!-- JsBarcode pour générer des codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body {
      background-color: #ffffff;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    h1 {
      font-weight: 700;
      margin-bottom: 30px;
    }
    .card {
      box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
      border: none;
      margin-bottom: 20px;
      border-radius: 0.5rem;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .barcode-card svg {
      margin: 0 auto 10px auto;
      display: block;
    }
    .result-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .feedback-btn {
      min-width: 90px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Extraction Avancée des Serial Numbers</h1>
    
    <!-- Zone de prise de photo -->
    <div class="mb-3">
      <label for="imageInput" class="form-label">Prenez ou sélectionnez une photo :</label>
      <input type="file" id="imageInput" class="form-control" accept="image/*;capture=camera">
    </div>
    
    <div class="d-grid gap-2 mb-4">
      <button id="processBtn" class="btn btn-primary btn-lg">Analyser l'image</button>
    </div>
    
    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center" style="display:none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Analyse en cours...</p>
    </div>
    
    <!-- Affichage du texte OCR et des résultats -->
    <div id="results" style="display:none;">
      <div class="card p-3">
        <div class="result-title">Texte OCR complet :</div>
        <pre id="output" class="bg-light p-2 rounded"></pre>
      </div>
      <div class="card p-3">
        <div class="result-title">Serial Numbers extraits :</div>
        <ul id="serialList" class="list-group mt-2"></ul>
      </div>
    </div>
    
    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="row"></div>
  </div>

  <script>
    /**************************************
     * "Machine Learning" simulé par feedback
     * Les numéros validés sont sauvegardés localement.
     **************************************/
    const STORAGE_KEY = 'confirmedSerialNumbers';
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      let confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }
    
    /*****************************************************
     * Extraction intelligente des serial numbers
     * On recherche les indicateurs :
     *   - serial number, numéro de série, n° de série
     *   - part number, pièces sérialisées, etc.
     * Puis on récupère la suite qui peut contenir espaces, tirets, etc.
     *****************************************************/
    function extractSerialNumbers(text) {
      let results = [];
      
      // Nettoyage de base pour éviter certains caractères spéciaux indésirables
      text = text.replace(/[“”«»]/g, '"');

      // Définition de plusieurs expressions régulières pour capter différentes variantes
      const regexPatterns = [
        // Variantes en anglais et français
        /(?:serial\s*numbers?|num(?:é|e)ro\s*de\s*s[eé]rie|n°\s*de\s*s[eé]rie|part\s*numbers?|part\s*number|pi[èe]ces?\s*s[ée]rialis[éee]s?\s*n[°o]?)\s*[:\-]?\s*([\w\s\-\_]+)/gi,
        // Une autre approche plus générique
        /(?:serie[s]?)\s*[:\-]?\s*([\w\s\-\_]+)/gi
      ];
      
      regexPatterns.forEach(regex => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          // Découpage sur virgule, point-virgule ou retour à la ligne
          let parts = match[1].split(/[\n,;]+/);
          parts.forEach(token => {
            token = token.trim();
            // Conserver les espaces internes si nécessaire, mais vérifier la longueur minimale
            let candidate = token.replace(/\s+/g, '');
            if (candidate.length >= 4 && !results.includes(token)) {
              results.push(token);
            }
          });
        }
      });
      
      // Si des numéros validés précédemment sont trouvés, les ramener en priorité
      const confirmed = getConfirmedSerialNumbers();
      results = results.sort((a, b) => {
        return (confirmed.includes(b) - confirmed.includes(a));
      });
      
      return results;
    }
    
    /*****************************************************
     * Affichage des résultats et des codes-barres
     *****************************************************/
    function displayResults(ocrText, serialNumbers) {
      // Affichage du texte OCR complet
      document.getElementById('output').textContent = ocrText;
      
      // Affichage de la liste avec feedback
      const serialList = document.getElementById('serialList');
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();
      
      if (serialNumbers.length === 0) {
        serialList.innerHTML = "<li class='list-group-item'>Aucun serial number détecté.</li>";
      } else {
        serialNumbers.forEach(num => {
          const li = document.createElement('li');
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = num + " (Len: " + num.replace(/\s/g, '').length + ")";
          
          const btnGroup = document.createElement('div');
          if (confirmed.includes(num)) {
            const badge = document.createElement('span');
            badge.className = "badge bg-success";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement('button');
            btnValidate.className = "btn btn-sm btn-outline-success feedback-btn me-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener('click', () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML = "<span class='badge bg-success'>Validé</span>";
            });
            const btnReject = document.createElement('button');
            btnReject.className = "btn btn-sm btn-outline-danger feedback-btn";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener('click', () => {
              li.remove();
            });
            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }
      
      // Affichage des codes-barres dans une grille
      const barcodeArea = document.getElementById('barcodeArea');
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const col = document.createElement('div');
        col.className = "col-12 col-sm-6 col-md-4 mb-3";
        
        const card = document.createElement('div');
        card.className = "card p-3 text-center barcode-card";
        
        const cardTitle = document.createElement('h5');
        cardTitle.textContent = num + " (Len: " + num.replace(/\s/g, '').length + ")";
        card.appendChild(cardTitle);
        
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "barcode" + index;
        card.appendChild(svg);
        
        col.appendChild(card);
        barcodeArea.appendChild(col);
        
        // Générer le code-barres
        JsBarcode(svg, num.replace(/\s/g, ''), {
          format: "CODE128",
          lineColor: "#000",
          width: 2,
          height: 60,
          displayValue: false
        });
      });
    }
    
    /*****************************************************
     * Lancement du processus OCR
     *****************************************************/
    document.getElementById('processBtn').addEventListener('click', () => {
      const file = document.getElementById('imageInput').files[0];
      if (!file) {
        alert("Veuillez prendre ou sélectionner une photo.");
        return;
      }
      
      // Réinitialisation des affichages
      document.getElementById('results').style.display = 'none';
      document.getElementById('barcodeArea').innerHTML = "";
      document.getElementById('serialList').innerHTML = "";
      document.getElementById('output').textContent = "";
      document.getElementById('loading').style.display = 'block';
      
      // Lancement de l'analyse OCR
      Tesseract.recognize(
        file,
        'fra',
        { logger: m => console.log(m) }
      ).then(({ data: { text } }) => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        // Extraction des serial numbers
        const extracted = extractSerialNumbers(text);
        displayResults(text, extracted);
      })
      .catch(err => {
        console.error(err);
        document.getElementById('loading').style.display = 'none';
        alert("Une erreur est survenue lors de l'analyse de l'image.");
      });
    });
  </script>
  
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>