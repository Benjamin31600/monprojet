<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>OCR Avancé avec OpenCV & Tesseract</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Tailwind CSS (CDN) pour un design très moderne -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  
  <!-- OpenCV.js pour prétraiter l'image côté client -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  
  <!-- JsBarcode (codes-barres) -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  
  <style>
    /* Styles additionnels pour un look plus premium */
    body {
      background: linear-gradient(120deg, #f9fafb 0%, #ffffff 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #1f2937;
    }
    .card {
      @apply bg-white shadow-md rounded-lg p-4 mb-6;
    }
    .title {
      @apply text-2xl font-bold text-center mb-6 uppercase tracking-wider;
    }
    .spinner {
      @apply animate-spin h-12 w-12 text-blue-600;
    }
    .btn-primary {
      @apply bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700;
    }
    .btn-secondary {
      @apply bg-gray-200 text-gray-700 py-2 px-4 rounded hover:bg-gray-300;
    }
    .badge {
      @apply inline-block px-2 py-1 text-xs font-semibold rounded;
    }
    .badge-success {
      @apply bg-green-500 text-white;
    }
    .feedback-btn {
      min-width: 80px;
    }
    .barcode-card {
      @apply bg-white shadow-md rounded p-4 flex flex-col items-center;
    }
    .barcode-title {
      @apply text-sm font-semibold mb-2 text-center;
    }
    .textarea-ocr {
      @apply w-full h-40 p-2 border border-gray-300 rounded mt-2 bg-gray-50;
      resize: none;
    }
    /* Masque de compatibilité si Tailwind JIT non actif */
    [class^="@apply"] {
      /* no-op, for fallback */
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <div class="container mx-auto p-4 max-w-3xl">
    <h1 class="title">OCR Avancé des Serial Numbers</h1>

    <!-- Zone de sélection / prise de photo -->
    <div class="card">
      <label class="block mb-2 font-semibold" for="imageInput">
        Sélectionnez ou prenez une photo :
      </label>
      <input
        type="file"
        id="imageInput"
        class="block w-full mb-4"
        accept="image/*;capture=camera"
      />
      <button
        id="processBtn"
        class="btn-primary w-full text-center font-semibold"
      >
        Analyser l'image
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center my-8 hidden">
      <svg
        class="spinner mx-auto"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v8H4z"
        ></path>
      </svg>
      <p class="mt-2 text-blue-600 font-semibold">Analyse en cours...</p>
    </div>

    <!-- Résultats -->
    <div id="results" class="hidden">
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Texte OCR brut :</h2>
        <textarea id="output" class="textarea-ocr" readonly></textarea>
      </div>

      <div class="card">
        <h2 class="text-lg font-bold mb-2">Serial Numbers détectés :</h2>
        <ul id="serialList" class="space-y-2"></ul>
      </div>
    </div>

    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

    <p class="text-center text-sm text-gray-500 mt-6">
      Les numéros validés sont mémorisés et remontent en priorité. <br />
      Si le lecteur ne parvient pas à scanner, augmentez la taille (width/height).
    </p>
  </div>

  <script>
    /************************************************************
     * Pseudo "Machine Learning" local : stockage
     ************************************************************/
    const STORAGE_KEY = "confirmedSerialNumbers";
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      const confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }

    /************************************************************
     * Prétraitement d'image (OpenCV.js)
     *  - On fait un traitement simple : conversion en niveaux de gris,
     *    binarisation (threshold), etc. pour réduire le bruit.
     ************************************************************/
    async function preprocessImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function () {
          // Créer un canvas de la taille de l'image
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          
          // Quand OpenCV est chargé (Module), on peut traiter
          if (typeof cv === "undefined") {
            // Si opencv.js n'est pas encore chargé
            return resolve(canvas.toDataURL("image/png"));
          }

          try {
            // Convertir en Mat OpenCV
            let src = cv.imread(canvas);
            let dst = new cv.Mat();

            // Convertir en niveau de gris
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

            // Binarisation adaptative
            let thresh = new cv.Mat();
            cv.adaptiveThreshold(
              dst,
              thresh,
              255,
              cv.ADAPTIVE_THRESH_GAUSSIAN_C,
              cv.THRESH_BINARY,
              15,
              15
            );

            // (Optionnel) enlever du bruit
            let ksize = new cv.Size(3, 3);
            cv.medianBlur(thresh, thresh, 3);

            // Remettre dans le canvas
            cv.imshow(canvas, thresh);

            // Libérer la mémoire
            src.delete();
            dst.delete();
            thresh.delete();

            // Retourner l'image traitée en base64
            resolve(canvas.toDataURL("image/png"));
          } catch (e) {
            console.error(e);
            resolve(canvas.toDataURL("image/png"));
          }
        };
        img.onerror = reject;
        // Charger l'image depuis le File
        const reader = new FileReader();
        reader.onload = function (evt) {
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    /************************************************************
     * Extraction avancée des Serial Numbers
     ************************************************************/
    function extractSerialNumbers(rawText) {
      // 1) Nettoyage agressif
      let text = rawText
        .replace(/[? ]/g, "") // retire ? et  
        .replace(/[“”«»]/g, '"')
        // enlever accents
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        // éventuellement tout passer en majuscules (optionnel)
        .toUpperCase();

      // 2) Patterns multiples
      const patterns = [
        // Pièces sérialisées, SER, S/N, Part Number, etc.
        /(?:PIECES?\s*SERIALISEES?\s*N[°O]?|SERIAL\s*NUMBERS?|S\/N|SER\s|N°\sDE\SSERIE|NUMERO\sDE\SSERIE|PART\s*NUMBER)\s*[:\-]?\s*([\w\s\-\_]*)/gi,
        // SER CHT 1522 ou SERCHT1522
        /\bSER\s?[A-Z]{0,5}\s?\d+\b/gi,
      ];

      let found = [];
      patterns.forEach((regex) => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          let parts = match[1] ? match[1].split(/[\n,;]+/) : [match[0]];
          parts.forEach((token) => {
            let candidate = token.trim();
            let candidateNoSpace = candidate.replace(/\s+/g, "");
            if (candidateNoSpace.length >= 3 && !found.includes(candidate)) {
              found.push(candidate);
            }
          });
        }
      });

      // 3) Prioriser les numéros déjà validés
      const confirmed = getConfirmedSerialNumbers();
      found.sort((a, b) => confirmed.includes(b) - confirmed.includes(a));

      return found;
    }

    /************************************************************
     * Affichage du texte OCR, liste, codes-barres
     ************************************************************/
    function displayResults(ocrText, serialNumbers) {
      // 1) Afficher le texte OCR
      const outputEl = document.getElementById("output");
      outputEl.value = ocrText;

      // 2) Afficher la liste
      const serialList = document.getElementById("serialList");
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();

      if (serialNumbers.length === 0) {
        const li = document.createElement("li");
        li.className = "bg-gray-100 p-2 rounded";
        li.textContent = "Aucun numéro de série détecté.";
        serialList.appendChild(li);
      } else {
        serialNumbers.forEach((num) => {
          const li = document.createElement("li");
          li.className =
            "bg-gray-50 p-2 rounded flex justify-between items-center";
          const len = num.replace(/\s+/g, "").length;
          li.textContent = `${num} (LEN: ${len})`;

          // Feedback
          const btnGroup = document.createElement("div");
          if (confirmed.includes(num)) {
            // Badge validé
            const badge = document.createElement("span");
            badge.className = "badge badge-success text-white";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement("button");
            btnValidate.className =
              "feedback-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener("click", () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML = `<span class="badge badge-success text-white">Validé</span>`;
            });

            const btnReject = document.createElement("button");
            btnReject.className =
              "feedback-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener("click", () => {
              li.remove();
            });

            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }

      // 3) Codes-barres
      const barcodeArea = document.getElementById("barcodeArea");
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const div = document.createElement("div");
        div.className = "barcode-card";

        const cardTitle = document.createElement("div");
        cardTitle.className = "barcode-title";
        const len = num.replace(/\s+/g, "").length;
        cardTitle.textContent = `${num} (LEN: ${len})`;
        div.appendChild(cardTitle);

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = `barcode-${index}`;
        div.appendChild(svg);

        barcodeArea.appendChild(div);

        // Génération du code-barres (plus grand qu'avant)
        JsBarcode(svg, num.replace(/\s+/g, ""), {
          format: "CODE128",
          lineColor: "#000",
          width: 3,   // Augmenté pour faciliter le flash
          height: 80, // Augmenté pour faciliter le flash
          displayValue: false,
        });
      });
    }

    /************************************************************
     * Processus global : prétraitement + OCR + extraction
     ************************************************************/
    document
      .getElementById("processBtn")
      .addEventListener("click", async function handleClick() {
        const file = document.getElementById("imageInput").files[0];
        if (!file) {
          alert("Veuillez choisir ou prendre une photo.");
          return;
        }

        const loadingEl = document.getElementById("loading");
        const resultsEl = document.getElementById("results");
        const barcodeArea = document.getElementById("barcodeArea");
        const serialList = document.getElementById("serialList");
        const outputEl = document.getElementById("output");

        // Réinitialiser l'affichage
        resultsEl.classList.add("hidden");
        barcodeArea.innerHTML = "";
        serialList.innerHTML = "";
        outputEl.value = "";
        loadingEl.classList.remove("hidden");

        try {
          // 1) Prétraiter l'image via OpenCV.js
          const processedDataUrl = await preprocessImage(file);

          // 2) Passer l'image traitée à Tesseract
          const { data } = await Tesseract.recognize(processedDataUrl, "fra", {
            logger: (m) => console.log(m),
          });
          const text = data.text;

          // 3) Extraire les numéros
          const extracted = extractSerialNumbers(text);

          // 4) Afficher
          loadingEl.classList.add("hidden");
          resultsEl.classList.remove("hidden");
          displayResults(text, extracted);
        } catch (err) {
          console.error(err);
          loadingEl.classList.add("hidden");
          alert("Une erreur est survenue lors de l'analyse.");
        }
      });
  </script>
</body>
</html>