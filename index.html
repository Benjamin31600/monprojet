<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCR Avancé : Extraction & Apprentissage des Serial Numbers</title>
  
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Tesseract.js pour l'OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <!-- JsBarcode pour générer des codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  
  <style>
    /* ====== Style général pour un rendu plus premium et responsive ====== */
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f2f5 0%, #ffffff 100%);
      min-height: 100vh;
    }

    .container {
      padding: 40px 20px;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      font-weight: 700;
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      color: #2c3e50;
    }

    .card {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .barcode-card svg {
      margin: 0 auto 10px auto;
      display: block;
    }

    .result-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: #34495e;
    }

    .feedback-btn {
      min-width: 90px;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .footer-note {
      text-align: center;
      color: #777;
      font-size: 0.9rem;
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>OCR Avancé : Serial Numbers</h1>

    <!-- Sélection / prise de photo -->
    <div class="mb-3">
      <label for="imageInput" class="form-label"
        >Prenez ou sélectionnez une photo :</label
      >
      <input
        type="file"
        id="imageInput"
        class="form-control"
        accept="image/*;capture=camera"
      />
    </div>

    <div class="d-grid gap-2 mb-4">
      <button id="processBtn" class="btn btn-primary btn-lg">
        Analyser l'image
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center" style="display: none">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Analyse en cours...</p>
    </div>

    <!-- Zone d'affichage des résultats -->
    <div id="results" style="display: none">
      <!-- Texte OCR brut -->
      <div class="card p-3">
        <div class="result-title">Texte OCR complet :</div>
        <pre id="output" class="bg-light p-2 rounded"></pre>
      </div>

      <!-- Liste des serial numbers extraits -->
      <div class="card p-3">
        <div class="result-title">Serial Numbers extraits :</div>
        <ul id="serialList" class="list-group mt-2"></ul>
      </div>
    </div>

    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="row"></div>

    <div class="footer-note">
      <p>
        Astuce : Sur PC, vous devrez choisir un fichier image.<br />
        Sur smartphone, vous pouvez prendre une photo directement.<br />
        Si le lecteur code-barres ne détecte pas, augmentez la taille (width/height).
      </p>
    </div>
  </div>

  <script>
    /****************************************************
     * Pseudo "Machine Learning" : stockage local
     ****************************************************/
    const STORAGE_KEY = "confirmedSerialNumbers";
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      const confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }

    /****************************************************
     * Extraction avancée des Serial Numbers
     * - On supprime les caractères ? et on retire certains symboles
     * - On cherche toutes les variantes (Part Number, Pièces sérialisées, SER, etc.)
     ****************************************************/
    function extractSerialNumbers(rawText) {
      // 1) Nettoyer le texte : supprimer points d'interrogation, guillemets exotiques, etc.
      let text = rawText
        .replace(/\?/g, "") // retire les ?
        .replace(/[“”«»]/g, '"')
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, ""); // retire accents

      // 2) Définir plusieurs motifs
      //    On capture la suite (lettres, chiffres, espaces, tirets, underscores)
      const patterns = [
        // Variantes courantes : Pièces sérialisées N°, SER, S/N, Part Number, etc.
        /(?:pieces?\s*serialisees?\s*n[°o]?|serial\s*numbers?|s\/n|ser\s|n°\sde\sserie|numero\sde\sserie|part\s*number)\s*[:\-]?\s*([\w\s\-\_]*)/gi,
        // SER CHT 1522 ou SERCHT1522
        /\bSER\s?[A-Z]{0,5}\s?\d+\b/gi,
      ];

      let found = [];
      patterns.forEach((regex) => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          // Séparer sur sauts de ligne, virgules, etc.
          let parts = match[1] ? match[1].split(/[\n,;]+/) : [match[0]];
          parts.forEach((token) => {
            let candidate = token.trim();
            let candidateNoSpace = candidate.replace(/\s+/g, "");
            // On exige une longueur minimale pour éviter les faux positifs
            if (candidateNoSpace.length >= 3 && !found.includes(candidate)) {
              found.push(candidate);
            }
          });
        }
      });

      // 3) Prioriser les numéros déjà validés
      const confirmed = getConfirmedSerialNumbers();
      found.sort((a, b) => confirmed.includes(b) - confirmed.includes(a));

      return found;
    }

    /****************************************************
     * Affichage : texte OCR, liste, codes-barres
     ****************************************************/
    function displayResults(ocrText, serialNumbers) {
      // Afficher le texte OCR brut
      document.getElementById("output").textContent = ocrText;

      // Afficher la liste de numéros
      const serialList = document.getElementById("serialList");
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();

      if (serialNumbers.length === 0) {
        serialList.innerHTML =
          "<li class='list-group-item'>Aucun numéro de série détecté.</li>";
      } else {
        serialNumbers.forEach((num) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          // Longueur sans espaces
          const len = num.replace(/\s+/g, "").length;
          li.textContent = `${num} (Len: ${len})`;

          // Boutons feedback
          const btnGroup = document.createElement("div");
          if (confirmed.includes(num)) {
            // Déjà validé
            const badge = document.createElement("span");
            badge.className = "badge bg-success";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement("button");
            btnValidate.className =
              "btn btn-sm btn-outline-success feedback-btn me-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener("click", () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML =
                "<span class='badge bg-success'>Validé</span>";
            });

            const btnReject = document.createElement("button");
            btnReject.className = "btn btn-sm btn-outline-danger feedback-btn";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener("click", () => {
              li.remove();
            });

            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }

      // Génération des codes-barres
      const barcodeArea = document.getElementById("barcodeArea");
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-md-4 mb-3";

        const card = document.createElement("div");
        card.className = "card p-3 text-center barcode-card";

        const cardTitle = document.createElement("h5");
        const len = num.replace(/\s+/g, "").length;
        cardTitle.textContent = `${num} (Len: ${len})`;
        card.appendChild(cardTitle);

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "barcode" + index;
        card.appendChild(svg);

        col.appendChild(card);
        barcodeArea.appendChild(col);

        // Générer le code-barres (on retire les espaces internes)
        JsBarcode(svg, num.replace(/\s+/g, ""), {
          format: "CODE128",
          lineColor: "#000",
          width: 2,   // Augmentez à 3 ou 4 pour un code-barres plus large
          height: 60, // Augmentez si besoin d'une hauteur plus grande
          displayValue: false,
        });
      });
    }

    /****************************************************
     * Lancement du processus OCR
     ****************************************************/
    document
      .getElementById("processBtn")
      .addEventListener("click", function handleClick() {
        const file = document.getElementById("imageInput").files[0];
        if (!file) {
          alert("Veuillez prendre ou sélectionner une photo.");
          return;
        }

        // Réinitialisation des affichages
        document.getElementById("results").style.display = "none";
        document.getElementById("barcodeArea").innerHTML = "";
        document.getElementById("serialList").innerHTML = "";
        document.getElementById("output").textContent = "";
        document.getElementById("loading").style.display = "block";

        // Lancement de l'analyse OCR
        Tesseract.recognize(file, "fra", { logger: (m) => console.log(m) })
          .then(({ data: { text } }) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("results").style.display = "block";

            // Extraire les serial numbers
            const extracted = extractSerialNumbers(text);

            // Afficher les résultats
            displayResults(text, extracted);
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("loading").style.display = "none";
            alert("Une erreur est survenue lors de l'analyse de l'image.");
          });
      });
  </script>

  <!-- Bootstrap 5 JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>