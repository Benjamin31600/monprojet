<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extraction Avancée des Serial Numbers</title>
  <!-- Bootstrap 5 CSS pour un design moderne et professionnel -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Tesseract.js pour l'OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <!-- JsBarcode pour générer des codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    /* --- Style général pour un rendu plus "corporate" --- */
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e8eaed 0%, #fdfdfd 100%);
      min-height: 100vh;
    }

    .container {
      padding: 30px 15px;
    }

    h1 {
      font-weight: 700;
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      color: #343a40;
    }

    .card {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .barcode-card svg {
      margin: 0 auto 10px auto;
      display: block;
    }

    .result-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .feedback-btn {
      min-width: 90px;
    }

    .footer-note {
      text-align: center;
      color: #777;
      font-size: 0.9rem;
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Extraction Avancée des Serial Numbers</h1>

    <!-- Zone de prise ou sélection de photo -->
    <div class="mb-3">
      <label for="imageInput" class="form-label"
        >Prenez ou sélectionnez une photo :</label
      >
      <input
        type="file"
        id="imageInput"
        class="form-control"
        accept="image/*;capture=camera"
      />
    </div>

    <div class="d-grid gap-2 mb-4">
      <button id="processBtn" class="btn btn-primary btn-lg">
        Analyser l'image
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center" style="display: none">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Analyse en cours...</p>
    </div>

    <!-- Zone d'affichage du texte OCR et des numéros extraits -->
    <div id="results" style="display: none">
      <div class="card p-3">
        <div class="result-title">Texte OCR complet :</div>
        <pre id="output" class="bg-light p-2 rounded"></pre>
      </div>

      <div class="card p-3">
        <div class="result-title">Serial Numbers extraits :</div>
        <ul id="serialList" class="list-group mt-2"></ul>
      </div>
    </div>

    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="row"></div>

    <div class="footer-note">
      <p>
        Astuce : Sur PC, vous devrez sélectionner un fichier image.<br />
        Sur smartphone, vous pouvez prendre une photo directement.
      </p>
    </div>
  </div>

  <script>
    /******************************************
     * Simulation d'Apprentissage Automatique
     * (stockage local des numéros validés)
     ******************************************/
    const STORAGE_KEY = "confirmedSerialNumbers";
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      const confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }

    /***************************************************
     * Extraction avancée des Serial Numbers
     *  - On normalise le texte pour gérer les caractères spéciaux (accents)
     *  - On recherche plusieurs variantes (SER, Pièces sérialisées N°, etc.)
     ****************************************************/
    function extractSerialNumbers(rawText) {
      // 1) Normaliser pour retirer les accents et caractères diacritiques
      let text = rawText
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // supprime les accents
        .replace(/[“”«»]/g, '"'); // guillemets exotiques

      // 2) Définir un ensemble de patterns plus large
      //    On cherche la mention, puis on capture la suite
      //    (lettres, chiffres, espaces, tirets, underscores, etc.)
      const patterns = [
        // Pièces sérialisées N°, SER, S/N, Part Number, etc.
        /(?:pieces?\s*serialisees?\s*n[°o]?|serial\s*numbers?|s\/n|ser\s|n°\sde\sserie|numero\sde\sserie|part\s*number)\s*[:\-]?\s*([\w\s\-\_]*)/gi,
        // Parfois, "SER CHT 1522" ou "SERCHT1522" direct
        /\bSER\s?[A-Z]{0,5}\s?\d+\b/gi,
      ];

      // 3) Rassembler tous les résultats
      let found = [];
      patterns.forEach((regex) => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          // Séparer éventuellement sur points-virgules, virgules, retours à la ligne
          let parts = match[1]
            ? match[1].split(/[\n,;]+/)
            : [match[0]]; // si la capture est sur match[0]
          parts.forEach((token) => {
            let candidate = token.trim();
            // Retirer les espaces internes pour calculer la longueur
            let candidateNoSpace = candidate.replace(/\s+/g, "");
            if (
              candidateNoSpace.length >= 3 && // on peut ajuster selon vos besoins
              !found.includes(candidate) &&
              !/^[\s\-]+$/.test(candidate)
            ) {
              found.push(candidate);
            }
          });
        }
      });

      // 4) Prioriser les numéros déjà validés
      const confirmed = getConfirmedSerialNumbers();
      found.sort((a, b) => confirmed.includes(b) - confirmed.includes(a));

      return found;
    }

    /*****************************************************
     * Affichage des résultats (texte + liste + codes-barres)
     *****************************************************/
    function displayResults(ocrText, serialNumbers) {
      // 1) Afficher le texte OCR complet
      document.getElementById("output").textContent = ocrText;

      // 2) Afficher la liste des serial numbers
      const serialList = document.getElementById("serialList");
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();

      if (serialNumbers.length === 0) {
        serialList.innerHTML =
          "<li class='list-group-item'>Aucun numéro de série détecté.</li>";
      } else {
        serialNumbers.forEach((num) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";

          // Calculer la longueur (sans espaces)
          const len = num.replace(/\s+/g, "").length;
          li.textContent = `${num} (Len: ${len})`;

          // Boutons de validation / rejet
          const btnGroup = document.createElement("div");
          if (confirmed.includes(num)) {
            // Si déjà validé, on affiche un badge "Validé"
            const badge = document.createElement("span");
            badge.className = "badge bg-success";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement("button");
            btnValidate.className =
              "btn btn-sm btn-outline-success feedback-btn me-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener("click", () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML =
                "<span class='badge bg-success'>Validé</span>";
            });

            const btnReject = document.createElement("button");
            btnReject.className = "btn btn-sm btn-outline-danger feedback-btn";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener("click", () => {
              li.remove();
            });

            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }

          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }

      // 3) Générer les codes-barres
      const barcodeArea = document.getElementById("barcodeArea");
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        // Création d'une colonne Bootstrap
        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-md-4 mb-3";

        // Création d'une carte
        const card = document.createElement("div");
        card.className = "card p-3 text-center barcode-card";

        // Titre de la carte
        const cardTitle = document.createElement("h5");
        const len = num.replace(/\s+/g, "").length;
        cardTitle.textContent = `${num} (Len: ${len})`;
        card.appendChild(cardTitle);

        // Élément SVG pour le code-barres
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "barcode" + index;
        card.appendChild(svg);

        col.appendChild(card);
        barcodeArea.appendChild(col);

        // Générer le code-barres (on retire les espaces internes)
        JsBarcode(svg, num.replace(/\s+/g, ""), {
          format: "CODE128",
          lineColor: "#000",
          width: 2,
          height: 60,
          displayValue: false,
        });
      });
    }

    /*****************************************************
     * Lancement du processus OCR
     *****************************************************/
    document
      .getElementById("processBtn")
      .addEventListener("click", function handleClick() {
        const file = document.getElementById("imageInput").files[0];
        if (!file) {
          alert("Veuillez prendre ou sélectionner une photo.");
          return;
        }

        // Réinitialisation des affichages
        document.getElementById("results").style.display = "none";
        document.getElementById("barcodeArea").innerHTML = "";
        document.getElementById("serialList").innerHTML = "";
        document.getElementById("output").textContent = "";
        document.getElementById("loading").style.display = "block";

        // Lancement de l'analyse OCR
        Tesseract.recognize(file, "fra", { logger: (m) => console.log(m) })
          .then(({ data: { text } }) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("results").style.display = "block";

            // Extraire les serial numbers
            const extracted = extractSerialNumbers(text);

            // Afficher les résultats
            displayResults(text, extracted);
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("loading").style.display = "none";
            alert("Une erreur est survenue lors de l'analyse de l'image.");
          });
      });
  </script>

  <!-- Bootstrap 5 JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>