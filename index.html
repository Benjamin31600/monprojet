<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>OCR Ultra Avancé (Client-Side)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Tailwind CSS pour un design très moderne -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  
  <!-- OpenCV.js pour prétraiter l'image (plus avancé) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  
  <!-- JsBarcode pour les codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    /* Fond dégradé plus marqué, pour un style "ultra moderne" */
    body {
      background: linear-gradient(120deg, #e2ebf0 0%, #ffffff 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1f2937;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    /* Header stylé */
    header {
      background: #1f2937;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      width: 100%;
      padding: 0 1rem;
    }
    .card {
      @apply bg-white shadow-md rounded-lg p-4 mb-6;
    }
    .title {
      @apply text-2xl font-bold mb-4 text-center uppercase tracking-wider;
      color: #111827;
    }
    .btn-primary {
      @apply bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-semibold;
    }
    .spinner {
      @apply animate-spin h-12 w-12 text-blue-600;
    }
    .feedback-btn {
      min-width: 80px;
    }
    .barcode-card {
      @apply bg-white shadow-md rounded p-4 flex flex-col items-center mb-4;
    }
    .barcode-title {
      @apply text-sm font-semibold mb-2 text-center;
    }
    textarea {
      @apply w-full p-2 border border-gray-300 rounded mt-2 bg-gray-50;
      resize: vertical;
    }
    /* Pour Tailwind fallback */
    [class^="@apply"] {
      /* no-op fallback */
    }
  </style>
</head>
<body>
  <header>Extraction Ultra-Avancée des Serial Numbers</header>
  
  <div class="container">
    <!-- Titre principal -->
    <h1 class="title">Analyse OCR & Codes-Barres</h1>

    <!-- Zone de sélection / prise de photo -->
    <div class="card">
      <label class="block font-semibold mb-2" for="imageInput">
        Sélectionnez ou prenez une photo :
      </label>
      <input
        type="file"
        id="imageInput"
        class="block w-full mb-4"
        accept="image/*;capture=camera"
      />
      <button
        id="processBtn"
        class="btn-primary w-full text-center"
      >
        Analyser l'image
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center my-8 hidden">
      <svg
        class="spinner mx-auto"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v8H4z"
        ></path>
      </svg>
      <p class="mt-2 text-blue-600 font-semibold">Analyse en cours...</p>
    </div>

    <!-- Résultats -->
    <div id="results" class="hidden">
      <!-- Texte OCR brut -->
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Texte OCR brut (ASCII only) :</h2>
        <textarea id="output" rows="8" readonly></textarea>
      </div>

      <!-- Liste des serial numbers -->
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Serial Numbers détectés :</h2>
        <ul id="serialList" class="space-y-2"></ul>
      </div>
    </div>

    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

    <p class="text-center text-sm text-gray-500 mt-6">
      Les numéros validés sont mémorisés (localStorage) et prioritaires.<br />
      Si un lecteur ne flashe pas, augmentez la taille (width/height).
    </p>
  </div>

  <script>
    /************************************************************
     * Pseudo "Machine Learning" local : stockage
     ************************************************************/
    const STORAGE_KEY = "confirmedSerialNumbers";
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      const confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }

    /************************************************************
     * Prétraitement d'image (OpenCV.js)
     ************************************************************/
    async function preprocessImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function () {
          // Canvas
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          // Vérifier si OpenCV est chargé
          if (typeof cv === "undefined") {
            return resolve(canvas.toDataURL("image/png"));
          }

          try {
            let src = cv.imread(canvas);
            let dst = new cv.Mat();

            // Convertir en niveaux de gris
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

            // Binarisation adaptative
            let thresh = new cv.Mat();
            cv.adaptiveThreshold(
              dst,
              thresh,
              255,
              cv.ADAPTIVE_THRESH_GAUSSIAN_C,
              cv.THRESH_BINARY,
              15,
              15
            );

            // Optionnel : petit flou pour réduire le bruit
            cv.medianBlur(thresh, thresh, 3);

            // Afficher sur le canvas
            cv.imshow(canvas, thresh);

            src.delete();
            dst.delete();
            thresh.delete();

            resolve(canvas.toDataURL("image/png"));
          } catch (err) {
            console.error(err);
            resolve(canvas.toDataURL("image/png"));
          }
        };
        img.onerror = reject;
        const reader = new FileReader();
        reader.onload = function (evt) {
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    /************************************************************
     * Extraction avancée des Serial Numbers
     *  - On enlève tout caractère hors ASCII
     *  - On passe en majuscules
     ************************************************************/
    function extractSerialNumbers(rawText) {
      // 1) Forcer ASCII : retirer tout ce qui est en dehors de [32-126]
      let text = rawText
        .replace(/[^\x20-\x7E]/g, "") // supprime tout hors ASCII
        .toUpperCase();

      // 2) Patterns
      const patterns = [
        // Pièces sérialisées, SER, S/N, Part Number, etc.
        /(?:PIECES?\s*SERIALISEES?\s*N[°O]?|SERIAL\s*NUMBERS?|S\/N|SER\s|N°\sDE\sSERIE|NUMERO\sDE\sSERIE|PART\s*NUMBER)\s*[:\-]?\s*([\w\s\-\_]*)/gi,
        // SER CHT 1522 ou SERCHT1522
        /\bSER\s?[A-Z]{0,5}\s?\d+\b/gi,
      ];

      let found = [];
      patterns.forEach((regex) => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          let parts = match[1] ? match[1].split(/[\n,;]+/) : [match[0]];
          parts.forEach((token) => {
            let candidate = token.trim();
            let candidateNoSpace = candidate.replace(/\s+/g, "");
            if (candidateNoSpace.length >= 3 && !found.includes(candidate)) {
              found.push(candidate);
            }
          });
        }
      });

      // 3) Prioriser les numéros déjà validés
      const confirmed = getConfirmedSerialNumbers();
      found.sort((a, b) => confirmed.includes(b) - confirmed.includes(a));

      return { text, found };
    }

    /************************************************************
     * Affichage du texte OCR, liste, codes-barres
     ************************************************************/
    function displayResults(ocrText, serialNumbers) {
      // 1) Texte OCR
      const outputEl = document.getElementById("output");
      outputEl.value = ocrText;

      // 2) Liste
      const serialList = document.getElementById("serialList");
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();

      if (serialNumbers.length === 0) {
        const li = document.createElement("li");
        li.className = "bg-gray-100 p-2 rounded";
        li.textContent = "Aucun numéro de série détecté.";
        serialList.appendChild(li);
      } else {
        serialNumbers.forEach((num) => {
          const li = document.createElement("li");
          li.className =
            "bg-gray-50 p-2 rounded flex justify-between items-center";
          const len = num.replace(/\s+/g, "").length;
          li.textContent = `${num} (LEN: ${len})`;

          // Feedback
          const btnGroup = document.createElement("div");
          if (confirmed.includes(num)) {
            // Badge validé
            const badge = document.createElement("span");
            badge.className =
              "badge badge-success px-2 py-1 text-white text-xs font-bold";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement("button");
            btnValidate.className =
              "feedback-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener("click", () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML = `<span class="badge badge-success px-2 py-1 text-white text-xs font-bold">Validé</span>`;
            });

            const btnReject = document.createElement("button");
            btnReject.className =
              "feedback-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener("click", () => {
              li.remove();
            });

            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }

      // 3) Codes-barres
      const barcodeArea = document.getElementById("barcodeArea");
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const div = document.createElement("div");
        div.className = "barcode-card";

        const cardTitle = document.createElement("div");
        cardTitle.className = "barcode-title";
        const len = num.replace(/\s+/g, "").length;
        cardTitle.textContent = `${num} (LEN: ${len})`;
        div.appendChild(cardTitle);

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = `barcode-${index}`;
        div.appendChild(svg);

        barcodeArea.appendChild(div);

        // Génération du code-barres (plus grand)
        JsBarcode(svg, num.replace(/\s+/g, ""), {
          format: "CODE128",
          lineColor: "#000",
          width: 3,   // Largeur augmentée
          height: 80, // Hauteur augmentée
          displayValue: false,
        });
      });
    }

    /************************************************************
     * Processus global : prétraitement + OCR + extraction
     ************************************************************/
    document
      .getElementById("processBtn")
      .addEventListener("click", async function handleClick() {
        const file = document.getElementById("imageInput").files[0];
        if (!file) {
          alert("Veuillez sélectionner ou prendre une photo.");
          return;
        }

        const loadingEl = document.getElementById("loading");
        const resultsEl = document.getElementById("results");
        const barcodeArea = document.getElementById("barcodeArea");
        const serialList = document.getElementById("serialList");
        const outputEl = document.getElementById("output");

        resultsEl.classList.add("hidden");
        barcodeArea.innerHTML = "";
        serialList.innerHTML = "";
        outputEl.value = "";
        loadingEl.classList.remove("hidden");

        try {
          // 1) Prétraiter via OpenCV
          const processedDataUrl = await preprocessImage(file);

          // 2) Tesseract (lang = fra+eng)
          const { data } = await Tesseract.recognize(processedDataUrl, "fra+eng", {
            logger: (m) => console.log(m),
          });
          let text = data.text;

          // 3) Extraire
          const { text: asciiText, found } = extractSerialNumbers(text);

          // 4) Afficher
          loadingEl.classList.add("hidden");
          resultsEl.classList.remove("hidden");
          displayResults(asciiText, found);
        } catch (err) {
          console.error(err);
          loadingEl.classList.add("hidden");
          alert("Une erreur est survenue lors de l'analyse.");
        }
      });
  </script>
</body>
</html>