<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>OCR Ultra - Refonte Totale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind CSS (CDN) pour un design très moderne -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <!-- OpenCV.js pour prétraiter l'image côté client -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <!-- JsBarcode pour générer les codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    /* ---- Hero Section en haut, style sombre ---- */
    .hero {
      background: linear-gradient(135deg, #1f2937 0%, #3b4252 100%);
      color: #fff;
      padding: 2rem 1rem;
      text-align: center;
    }
    .hero h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    .hero p {
      font-size: 1rem;
      opacity: 0.8;
    }

    /* ---- Container principal ---- */
    .container {
      max-width: 900px;
      margin: -4rem auto 2rem;
      padding: 0 1rem;
      position: relative;
    }

    /* ---- Carte stylée ---- */
    .card {
      @apply bg-white shadow-md rounded-lg p-4 mb-6;
    }

    /* ---- Boutons ---- */
    .btn-primary {
      @apply bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-semibold;
    }

    .btn-secondary {
      @apply bg-gray-200 text-gray-700 py-2 px-4 rounded hover:bg-gray-300 font-semibold;
    }

    /* ---- Spinner ---- */
    .spinner {
      @apply animate-spin h-12 w-12 text-blue-600;
    }

    /* ---- Feedback / Validation ---- */
    .feedback-btn {
      min-width: 80px;
    }

    /* ---- Cartes codes-barres ---- */
    .barcode-card {
      @apply bg-white shadow-md rounded p-4 flex flex-col items-center mb-4;
    }
    .barcode-title {
      @apply text-sm font-semibold mb-2 text-center;
    }

    /* ---- Textarea ---- */
    textarea {
      @apply w-full p-2 border border-gray-300 rounded mt-2 bg-gray-50;
      resize: vertical;
    }

    /* ---- Tailwind fallback for @apply if needed ---- */
    [class^="@apply"] {
      /* no-op fallback */
    }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100">
  <!-- Hero Section -->
  <div class="hero">
    <h1>Extraction Avancée des Serial Numbers</h1>
    <p>OCR client-side + pseudo-apprentissage local</p>
  </div>

  <div class="container">
    <!-- Carte d'upload -->
    <div class="card relative z-10">
      <label for="imageInput" class="block font-semibold mb-2">
        Sélectionnez ou prenez une photo :
      </label>
      <input
        type="file"
        id="imageInput"
        class="block w-full mb-4"
        accept="image/*;capture=camera"
      />
      <button id="processBtn" class="btn-primary w-full text-center">
        Analyser l'image
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center my-8 hidden">
      <svg
        class="spinner mx-auto"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v8H4z"
        ></path>
      </svg>
      <p class="mt-2 text-blue-600 font-semibold">Analyse en cours...</p>
    </div>

    <!-- Résultats -->
    <div id="results" class="hidden z-10 relative">
      <!-- Texte OCR brut (ASCII) -->
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Texte OCR (ASCII uniquement) :</h2>
        <textarea id="output" rows="8" readonly></textarea>
      </div>

      <!-- Liste de numéros -->
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Serial Numbers détectés :</h2>
        <ul id="serialList" class="space-y-2"></ul>
      </div>
    </div>

    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 z-10 relative"></div>
  </div>

  <footer class="mt-auto py-4 text-center text-sm text-gray-500 bg-gray-200">
    <p>
      Les numéros validés sont mémorisés en local et remontent en priorité.
      <br />
      Si un scanner ne lit pas le code-barres, augmentez la taille (width/height).
    </p>
  </footer>

  <script>
    /************************************************************
     * Pseudo "Machine Learning" local : stockage
     ************************************************************/
    const STORAGE_KEY = "confirmedSerialNumbers";
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      const confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }

    /************************************************************
     * Prétraitement d'image (OpenCV.js)
     ************************************************************/
    async function preprocessImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          // Vérifier OpenCV
          if (typeof cv === "undefined") {
            // Si non chargé, on retourne l'image brute
            return resolve(canvas.toDataURL("image/png"));
          }

          try {
            let src = cv.imread(canvas);
            let dst = new cv.Mat();

            // Niveaux de gris
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

            // Binarisation adaptative
            let thresh = new cv.Mat();
            cv.adaptiveThreshold(
              dst,
              thresh,
              255,
              cv.ADAPTIVE_THRESH_GAUSSIAN_C,
              cv.THRESH_BINARY,
              15,
              15
            );

            // Flou médian
            cv.medianBlur(thresh, thresh, 3);

            // Afficher
            cv.imshow(canvas, thresh);

            // Nettoyage
            src.delete();
            dst.delete();
            thresh.delete();

            resolve(canvas.toDataURL("image/png"));
          } catch (err) {
            console.error(err);
            resolve(canvas.toDataURL("image/png"));
          }
        };
        img.onerror = reject;
        const reader = new FileReader();
        reader.onload = (evt) => (img.src = evt.target.result);
        reader.readAsDataURL(file);
      });
    }

    /************************************************************
     * Extraction avancée des Serial Numbers
     *  - Filtrage ASCII (supprime les losanges, etc.)
     *  - Passage en majuscules
     ************************************************************/
    function extractSerialNumbers(rawText) {
      // 1) Forcer ASCII only
      let text = rawText
        .replace(/[^\x20-\x7E]/g, "") // supprime tout hors ASCII
        .toUpperCase();

      // 2) Recherche via plusieurs regex
      const patterns = [
        // Pièces sérialisées, SER, S/N, Part Number...
        /(?:PIECES?\s*SERIALISEES?\s*N[°O]?|SERIAL\s*NUMBERS?|S\/N|SER\s|N°\sDE\sSERIE|NUMERO\sDE\sSERIE|PART\s*NUMBER)\s*[:\-]?\s*([\w\s\-\_]*)/gi,
        // SER CHT 1522 ou SERCHT1522
        /\bSER\s?[A-Z]{0,5}\s?\d+\b/gi,
      ];

      let found = [];
      patterns.forEach((regex) => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          let parts = match[1] ? match[1].split(/[\n,;]+/) : [match[0]];
          parts.forEach((token) => {
            let candidate = token.trim();
            let candidateNoSpace = candidate.replace(/\s+/g, "");
            if (candidateNoSpace.length >= 3 && !found.includes(candidate)) {
              found.push(candidate);
            }
          });
        }
      });

      // 3) Prioriser les numéros validés
      const confirmed = getConfirmedSerialNumbers();
      found.sort((a, b) => confirmed.includes(b) - confirmed.includes(a));

      return { asciiText: text, found };
    }

    /************************************************************
     * Affichage du texte OCR, liste, codes-barres
     ************************************************************/
    function displayResults(asciiText, serialNumbers) {
      // 1) Texte OCR
      const outputEl = document.getElementById("output");
      outputEl.value = asciiText;

      // 2) Liste
      const serialList = document.getElementById("serialList");
      serialList.innerHTML = "";
      const confirmed = getConfirmedSerialNumbers();

      if (serialNumbers.length === 0) {
        const li = document.createElement("li");
        li.className = "bg-gray-100 p-2 rounded";
        li.textContent = "Aucun numéro de série détecté.";
        serialList.appendChild(li);
      } else {
        serialNumbers.forEach((num) => {
          const li = document.createElement("li");
          li.className =
            "bg-gray-50 p-2 rounded flex justify-between items-center";
          const len = num.replace(/\s+/g, "").length;
          li.textContent = `${num} (LEN: ${len})`;

          // Feedback
          const btnGroup = document.createElement("div");
          if (confirmed.includes(num)) {
            // Badge validé
            const badge = document.createElement("span");
            badge.className =
              "bg-green-500 text-white text-xs font-bold px-2 py-1 rounded";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValidate = document.createElement("button");
            btnValidate.className =
              "feedback-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-2";
            btnValidate.textContent = "Valider";
            btnValidate.addEventListener("click", () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML =
                '<span class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded">Validé</span>';
            });

            const btnReject = document.createElement("button");
            btnReject.className =
              "feedback-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded";
            btnReject.textContent = "Rejeter";
            btnReject.addEventListener("click", () => {
              li.remove();
            });

            btnGroup.appendChild(btnValidate);
            btnGroup.appendChild(btnReject);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }

      // 3) Codes-barres
      const barcodeArea = document.getElementById("barcodeArea");
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const div = document.createElement("div");
        div.className = "barcode-card";

        const cardTitle = document.createElement("div");
        cardTitle.className = "barcode-title";
        const len = num.replace(/\s+/g, "").length;
        cardTitle.textContent = `${num} (LEN: ${len})`;
        div.appendChild(cardTitle);

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = `barcode-${index}`;
        div.appendChild(svg);

        barcodeArea.appendChild(div);

        // Génération du code-barres
        JsBarcode(svg, num.replace(/\s+/g, ""), {
          format: "CODE128",
          lineColor: "#000",
          width: 4,   // encore plus large
          height: 100, // encore plus haut
          displayValue: false,
        });
      });
    }

    /************************************************************
     * Processus global : prétraitement + OCR + extraction
     ************************************************************/
    document
      .getElementById("processBtn")
      .addEventListener("click", async function handleClick() {
        const file = document.getElementById("imageInput").files[0];
        if (!file) {
          alert("Veuillez choisir ou prendre une photo.");
          return;
        }

        const loadingEl = document.getElementById("loading");
        const resultsEl = document.getElementById("results");
        const barcodeArea = document.getElementById("barcodeArea");
        const serialList = document.getElementById("serialList");
        const outputEl = document.getElementById("output");

        resultsEl.classList.add("hidden");
        barcodeArea.innerHTML = "";
        serialList.innerHTML = "";
        outputEl.value = "";
        loadingEl.classList.remove("hidden");

        try {
          // 1) Prétraiter via OpenCV
          const processedDataUrl = await preprocessImage(file);

          // 2) Tesseract (multi-langues : fra+eng)
          const { data } = await Tesseract.recognize(processedDataUrl, "fra+eng", {
            logger: (m) => console.log(m),
          });
          let text = data.text || "";

          // 3) Extraire
          const { asciiText, found } = extractSerialNumbers(text);

          // 4) Afficher
          loadingEl.classList.add("hidden");
          resultsEl.classList.remove("hidden");
          displayResults(asciiText, found);
        } catch (err) {
          console.error(err);
          loadingEl.classList.add("hidden");
          alert("Une erreur est survenue lors de l'analyse.");
        }
      });
  </script>
</body>
</html>