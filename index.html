<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Extraction & Apprentissage des Serial Numbers</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tesseract.js pour l'OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <!-- JsBarcode pour les codes-barres -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
      border: none;
      margin-bottom: 15px;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .barcode-card svg {
      margin: auto;
      display: block;
      margin-bottom: 10px;
    }
    .result-title {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .feedback-btn {
      min-width: 90px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">Extraction & Apprentissage des Serial Numbers</h1>
    
    <!-- Zone de prise de photo / sélection d'image -->
    <div class="mb-3">
      <label for="imageInput" class="form-label">Prenez ou sélectionnez une photo :</label>
      <input type="file" id="imageInput" class="form-control" accept="image/*;capture=camera">
    </div>
    
    <div class="d-grid gap-2 mb-4">
      <button id="processBtn" class="btn btn-primary btn-lg">Analyser l'image</button>
    </div>
    
    <!-- Indicateur de chargement -->
    <div id="loading" class="text-center" style="display:none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Analyse de l'image en cours...</p>
    </div>
    
    <!-- Zone des résultats -->
    <div id="results" style="display:none;">
      <div class="card p-3 mb-3">
        <div class="result-title">Texte extrait :</div>
        <pre id="output" class="bg-light p-2 rounded"></pre>
      </div>
      
      <div class="card p-3 mb-3">
        <div class="result-title">Serial Numbers extraits :</div>
        <ul id="serialList" class="list-group mt-2"></ul>
      </div>
    </div>
    
    <!-- Zone d'affichage des codes-barres -->
    <div id="barcodeArea" class="row"></div>
  </div>

  <script>
    /**************************************************
    * Gestion de l'apprentissage (sauvegarde locale)
    ***************************************************/
    const STORAGE_KEY = 'confirmedSerialNumbers';
    function getConfirmedSerialNumbers() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }
    function addConfirmedSerialNumber(num) {
      let confirmed = getConfirmedSerialNumbers();
      if (!confirmed.includes(num)) {
        confirmed.push(num);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmed));
      }
    }
    
    /**************************************************
    * Extraction des serial numbers via OCR
    * On recherche les indicateurs suivants dans le texte :
    * "numéro de série", "n° de série", "serial numbers", etc.
    * et on extrait la partie qui suit, en autorisant espaces et caractères.
    ***************************************************/
    function extractSerialNumbers(text) {
      let results = [];
      
      // Nettoyer certains caractères spéciaux
      text = text.replace(/[“”«»]/g, '"');
      
      // Expressions régulières pour détecter les indicateurs suivis d'une séquence
      // On accepte des espaces, lettres, chiffres et tirets.
      const regexPatterns = [
        /(?:num(?:é|e)ro\s*de\s*s[eé]rie(?:s)?|n°\s*de\s*s[eé]rie|serial\s*numbers?)\s*[:\-]?\s*([\w\s\-]+)/gi,
        // Option générique : si la ligne contient le mot "serie" suivi d'une séquence
        /serie\s*[:\-]?\s*([\w\s\-]+)/gi
      ];
      
      regexPatterns.forEach(regex => {
        let match;
        while ((match = regex.exec(text)) !== null) {
          // On prend le groupe 1 qui contient la séquence après l'indicateur
          // Découper selon des délimiteurs (virgules, retours à la ligne)
          let parts = match[1].split(/[\n,;]+/);
          parts.forEach(token => {
            token = token.trim();
            // On retire les espaces internes si besoin et on vérifie la longueur minimale
            let candidate = token.replace(/\s+/g, '');
            if (candidate.length >= 4 && !results.includes(candidate)) {
              results.push(candidate);
            }
          });
        }
      });
      
      return results;
    }
    
    /**************************************************
    * Affichage des résultats et gestion du feedback
    ***************************************************/
    function displayResults(ocrText, serialNumbers) {
      // Afficher le texte OCR complet
      document.getElementById('output').textContent = ocrText;
      
      // Affichage de la liste des serial numbers avec feedback
      const serialList = document.getElementById('serialList');
      serialList.innerHTML = "";
      let confirmed = getConfirmedSerialNumbers();
      
      if (serialNumbers.length === 0) {
        serialList.innerHTML = "<li class='list-group-item'>Aucun serial number détecté.</li>";
      } else {
        serialNumbers.forEach(num => {
          const li = document.createElement('li');
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = num + " (Len: " + num.length + ")";
          
          // Boutons de feedback
          const btnGroup = document.createElement('div');
          if (confirmed.includes(num)) {
            // Déjà validé
            const badge = document.createElement('span');
            badge.className = "badge bg-success";
            badge.textContent = "Validé";
            btnGroup.appendChild(badge);
          } else {
            const btnValider = document.createElement('button');
            btnValider.className = "btn btn-sm btn-outline-success feedback-btn me-2";
            btnValider.textContent = "Valider";
            btnValider.addEventListener('click', () => {
              addConfirmedSerialNumber(num);
              btnGroup.innerHTML = "<span class='badge bg-success'>Validé</span>";
            });
            const btnRejeter = document.createElement('button');
            btnRejeter.className = "btn btn-sm btn-outline-danger feedback-btn";
            btnRejeter.textContent = "Rejeter";
            btnRejeter.addEventListener('click', () => {
              // En cas de rejet, on retire le numéro de l'affichage
              li.remove();
              // On peut aussi éventuellement le stocker en liste de rejet...
            });
            btnGroup.appendChild(btnValider);
            btnGroup.appendChild(btnRejeter);
          }
          li.appendChild(btnGroup);
          serialList.appendChild(li);
        });
      }
      
      // Affichage des codes-barres
      const barcodeArea = document.getElementById('barcodeArea');
      barcodeArea.innerHTML = "";
      serialNumbers.forEach((num, index) => {
        const col = document.createElement('div');
        col.className = "col-12 col-sm-6 col-md-4";
        const card = document.createElement('div');
        card.className = "card p-3 text-center barcode-card";
        
        const cardTitle = document.createElement('h5');
        cardTitle.textContent = num + " (Len: " + num.length + ")";
        card.appendChild(cardTitle);
        
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "barcode" + index;
        card.appendChild(svg);
        
        col.appendChild(card);
        barcodeArea.appendChild(col);
        
        // Générer le code-barres
        JsBarcode(svg, num, {
          format: "CODE128",
          lineColor: "#000",
          width: 2,
          height: 60,
          displayValue: false
        });
      });
    }
    
    /**************************************************
    * Gestion du processus OCR
    ***************************************************/
    document.getElementById('processBtn').addEventListener('click', () => {
      const file = document.getElementById('imageInput').files[0];
      if (!file) {
        alert("Veuillez prendre ou sélectionner une photo.");
        return;
      }
      
      // Réinitialiser l'affichage
      document.getElementById('results').style.display = 'none';
      document.getElementById('barcodeArea').innerHTML = "";
      document.getElementById('serialList').innerHTML = "";
      document.getElementById('output').textContent = "";
      document.getElementById('loading').style.display = 'block';
      
      // Lancer l'OCR via Tesseract.js
      Tesseract.recognize(
        file,
        'fra',
        { logger: m => console.log(m) }
      ).then(({ data: { text } }) => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        // Extraction des serial numbers uniquement
        const extracted = extractSerialNumbers(text);
        // Afficher uniquement les numéros validés ou extraits
        displayResults(text, extracted);
      })
      .catch(err => {
        console.error(err);
        document.getElementById('loading').style.display = 'none';
        alert("Une erreur est survenue lors de l'analyse de l'image.");
      });
    });
  </script>
  
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>